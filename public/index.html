<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            html {
                padding: 0;
                margin: 0
            }
            body {
                font-family: Verdana;
                display: flex;
                flex-direction: column;
                padding: 0;
                margin: 0;
            }
            header, footer {
                background: #444;
                color: #fff;
                padding: 5px;
            }
            main {
                flex: 1 0 auto;
                background: white;
                display: flex;
                flex-basis: 10px;
            }
            #workflow, #result {
                flex: 1 0 auto;
                padding: 10px;
                margin: 5px;
                display: flex;
                flex-direction: column;
                xjustify-content: space-between;
                flex-basis: 10px;
            }
            label {
                font-weight: bold;
                flex: 0;
            }
            #workflow textarea {
                flex: 8 0 auto;
                margin: 5px 0;
            }
            .buttons {
                flex: 0 0 auto;
            }
            select {
                border: 1px solid #222;
                min-width: 200px;
                background: #fff;
            }
            button {
                background: #0078e7;
                color: #fff;
                min-width: 120px;
                min-height: 40px;
                border: none;
                font-size: 0.9em;
            }
            #code {
                overflow: auto;
                font-size: 12px;
                padding: 10px;
                margin: 5px 0;
            }
            #code div {
                flex: 1 0 auto;
            }
            #workflowId {
                padding: 5px;
                width: 60px;
                margin-bottom: 20px;
            }
            table {
                border: 1px solid;
                border-collapse: collapse;
                font-size: 8pt;
            }
            td, th {
                border: 1px solid;
                border-collapse: collapse;
                padding: 3px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Tahiti</h1>
        </header>
        <main>
            <div id="workflow">
                <label>Inform the Workflow id:</label>
                <select id="workflowId">
                </select>
                <div class="buttons">
                    <button id="load">Load</button>
                </div>

                <textarea id="workflowData">

                </textarea>
                <div class="buttons">
                    <button id="process">Process</button>
                </div>
            </div>
            <div id="result">
                <label>Result:</label>
                <div id="code">
                </div>
            </div>
        </main>
        <footer>
            (c) Lemonade Project - DCC UFMG (Brazil)
        </footer>
        <script src="js/tahiti.js" language="JavaScript"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function(){
                var afterLoadDataSources = function() {
                    var dataSourceLoader = function(id, callback) {
                        var req=new XMLHttpRequest();
                        req.open("GET",  'http://beta.ctweb.inweb.org.br/limonero/datasources/' + id + '?token=123456&attributes_name=true');
                        req.onreadystatechange = function() {
                            if (req.readyState == XMLHttpRequest.DONE) {
                                if (callback) {
                                    var ds = JSON.parse(req.responseText)
                                    callback(ds.attributes.map(function(attr) {return attr.name}));
                                }
                            }
                        }
                        req.send({});
                    }
                    var text = document.getElementById('workflowData');
                    var code = document.getElementById('code');
                    text.focus();

                    var load = document.getElementById('load');
                    load.onclick = function(ev){
                        var wfId = document.getElementById('workflowId');

                        var req = new XMLHttpRequest();
                        req.open("GET",  'http://teste.ctweb.inweb.org.br/tahiti/workflows/' + wfId.value + '?token=123456');
                        req.onreadystatechange = function() {
                            if (req.readyState == XMLHttpRequest.DONE) {
                                text.value = JSON.stringify(JSON.parse(req.responseText), null, 4);
                            }
                        }
                        req.send({});

                    };

                    var btn = document.getElementById('process');

                    btn.onclick = function(ev){
                        var workflow = JSON.parse(text.value);
                        var callback = function(tasks) {
                            code.innerHTML = '';
                            var htmlCode = []
                            htmlCode.push('<table style="border: 0">')
                            htmlCode.push('<tr>')
                            htmlCode.push('<th>Operation</th>')
                            htmlCode.push('<th>Comment</th>')
                            htmlCode.push('<th>Inputs</th>')
                            htmlCode.push('<th>Outputs</th>')
                            htmlCode.push('<th>Added</th>')

                            tasks.forEach(function(task) {
                                var inputs = (Array.prototype.concat.apply([], task.uiPorts.inputs.map(function(item) { return item.attributes })));
                                var outputs = task.uiPorts.output;
                                var delta = outputs.filter(function(v){ return inputs.indexOf(v) === -1 });
                                if (task.operation.slug !== 'comment'){
                                    htmlCode.push('<tr>')
                                    htmlCode.push(`<td><strong>${task.operation.slug}</strong> => ${task.id}</td>`)
                                    htmlCode.push(`<td>${task.forms.comment ? task.forms.comment.value: '-'}</td>`);
                                    htmlCode.push(`<td>${inputs.join(', ')}</td>`);
                                    htmlCode.push(`<td>${outputs.join(', ')}</td>`);
                                    htmlCode.push(`<td>${delta.join(', ')}</td>`);
                                    htmlCode.push('<tr>')
                                }
                            });
                            htmlCode.push('</table>')
                            code.innerHTML = htmlCode.join('');
                        };
                        TahitiAttributeSuggester.compute(workflow, dataSourceLoader, callback);

                    };
                }

                var req = new XMLHttpRequest();
                req.open("GET",  'http://teste.ctweb.inweb.org.br/tahiti/workflows' + '?fields=id,name&token=123456');
                req.onreadystatechange = function() {
                    var wfId = document.getElementById('workflowId');
                    if (req.readyState == XMLHttpRequest.DONE) {
                        var data = JSON.parse(req.responseText).data;
                        var code = [];
                        data.forEach(function(wf) {
                            code.push(`<option value="${wf.id}">${wf.id} - ${wf.name}</option>`);
                        });
                        wfId.innerHTML = code.join('');
                        afterLoadDataSources();
                    }
                }
                req.send({});
            });
        </script>
    </body>

</html>